\section{Kalman Filter design}
\label{sec:kfdesign}

A \ac{KF} is a type of observer that can be applied to estimate the state vector. This is done to filter the measurements from the vessel and smooth these. If the measurements are too noisy, such that the vessel changes direction suddenly, but should be surging forward, a filter can predict the modelled direction and compare this to the measurement.

The \ac{KF} comprises the deterministic part \todo{Determinisitc part? nick} of the model which estimates the state vector. This is corrected by means of measurements to estimate the final state vector.

The \ac{KF} is drawn as a block diagram as seen on figure~\vref{fig:blockkf} illustrating both the process and the \ac{KF} together. The upper part represent the process, which can both be a simulated model or the real vessel with measurements, here it is a linear state space model. The lower part is the \ac{KF} which takes in the measurements and estimates the new state vector based on these measurements. The \ac{KF} can be of different types: \ac{LKF}, \ac{EKF} or \ac{UKF}. The figure illustrates the \ac{LKF}. Choosing between these types of filters depends on the type of model used and the application. 

\begin{figure}
	\centering
	\includesvg{kf_on_sys}
	\caption{Block diagram of kalman filter resulting in the state estimate $\hat x_k^+$.}
	\label{fig:blockkf}
\end{figure}

The process model is the usual state space model in discrete form as:
\begin{align}
x_k &= \Phi_{k-1} x_{k-1} + G u_{k-1} + w_{k-1}\\
z_k &= H_k x_k + v_k
\end{align}
\noindent The \ac{LKF} prediction and update can be written as:
\begin{itemize}\tightlist
\item Prediction
\begin{align}
\hat x_k^- &= \Phi_{k-1}\ \hat x_{k-1}^+ + G u_{k-1} \\
P_k^- &= \Phi_{k-1}P_{k-1}^- \Phi_{k-1}^\top + Q_{k-1}
\end{align}
\item Update
\begin{align}
\bar{\mathbf{z}}_k &= z_k - H_k\ \hat x_k^-\\
S_k &= H_k\ P_k^-H_k^\top + R_k\\
K_k &= P_k^-H_k^\top S_k^-\\
\hat x_k^+ &= x_k^- + K_k \bar{\mathbf{z}}_k\\
P_k^+ &= (I - K_k H_k) P_k^-
\end{align}
\end{itemize}
%\begin{itemize}
%\item Prediction
%\begin{align}
%\hat x_{k}^- &= \Phi_{k}\ \hat x_{k-1}^- + G_{k}\ u_{k-1}\nonumber\\
%\hat z_{k}^- &= H_{k}\ \hat x_{k}^-\nonumber\\
%P_{k}^- &= \Phi_{k}\ P_{k-1}^-\ \Phi_{k}^T + Q_{k}\nonumber
%\end{align}
%
%\item Update
%\begin{align}
%K_{k} &= P_{k}^- H_{k}^T(H_{k} P_{k}^- H_{k}^T+R_{k})^{-1}\nonumber\\
%\hat x_{k}^+ &= \hat x_{k}^- + K_{k}(z_{k}-\hat z_{k}^-)\nonumber\\
%P_{k}^+ &= (I-K_{k}\ H_{k})P_{k}^-\nonumber
%\end{align}
%\end{itemize}
Where $P_{k}^-$ is the covariance propagation, $P_{k}^+$ is the update of covariance propagation, $Q$ is a covariance matrix with sensor variances and $R$ is a covariance matrix with model variances. $Q$ is a measure of how much the model is to be trusted. If the variance of the sensors are high this will imply that the model are to be trusted more than the noisy sensor measurements. These variances can sometimes be measured directly at the sensors and used in the $Q$ matrix. This leaves the $R$ matrix as the only design matrix left. $R$ is a measure of how much the measurement are to be trusted. If the variance of the model are high it might be better to trust the actual measurements. $z_k$ is the measurements from the sensors and $\bar{\mathbf{z}}_k$ is the difference between the measurements and the predicted state vector, $\hat x_k^-$. $S_k$ is the covariance matrix of the residual with the variance of the model included. $K_k$ is the optimal Kalman gain, in a \ac{MMSE} sense. 

The above mentioned \ac{KF} can only be applied on linear systems and transitions. Therefore is this not suited at the AAUSHIP. The position from the \ac{GPS} and the acceleration measurements needs to be rotated with a rotational matrix, which leads to non-linearities in the system. This can be seen on figure \vref{fig:intermediate-calc}. This entails that a \ac{LKF} cannot be used and an \ac{EKF} can be suited. The \ac{EKF} is used to linearise the non-linear terms in the system around the current estimate. In this case it will linearise the transition around the current measurements from the sensors to estimate the true output. The \ac{EKF} can be formulated in discrete form with the prediction and an update as:
\begin{itemize}\tightlist
\item Prediction
\begin{align}
\hat x_k^- &= f(\hat x_{k-1}^-,u_{k-1})\\
P_k^- &= F_{k-1}P_{k-1}^-F_{k-1}^\top+Q_{k-1}
\end{align}
\item Update
\begin{align}
\bar{\mathbf{z}}_k &= z_k - h(\hat x_k^-)\\
S_k &= H_k\ P_k^-H_k^\top + R_k\\
K_k &= P_k^-H_k^\top S_k^-\\
\hat x_k^+ &= x_k^- + K_k \bar{\mathbf{z}}_k\\
P_k^+ &= (I - K_k H_k) P_k^-
\end{align}
\end{itemize}
where the state transition and observation matrices are defined by their respective jacobians:
\begin{align}
F_{k-1} &= \left.\frac{\delta f}{\delta x}\right|_{\hat x_{k-1}^-,u_{k-1}}\\
H_k &= \left.\frac{\delta h}{\delta x}\right|_{\hat x_{k}^-}
\end{align}

\subsection{\acl{KF} in the case of AAUSHIP}
The input is given by the forces applied to the vessel. On AAUSHIP with the two twin properllers and two side thrusters as illustrated in seciton~\vref{sec:thrust_allocation}, this will result in forces in the surge and sway direction as well as a torque around yaw, the roll and pitch torques are neglected, such that the input vector becomes $u_k$.
\begin{align}
u_k = \tau =
\begin{bmatrix}
X & Y & 0 & 0 & N
\end{bmatrix}^\top
\end{align}
These are the forces that can be applied by the thrusters mounted at the vessel. It should be noted that the pitch and roll are not set as input, since no thrusters can control these, and should be treated as model variations.

$G$ is the $10 \times 5$ matrix from the discretised $B$ matrix from equation~\vref{eq:ss}.
The $G$ matrix takes the forces in $X$, $Y$ and $N$ as input, and neglects inputs in $\phi$ and $\theta$. The forces in $\phi$ and $\theta$ are outputs from the system that makes the vessel change in pitch and roll.

The dimensions of the different matrices used are checked as a type of sanity check and verify that the matrices are in correct size.

The covariance propagation matrix, the uncertainty of the estimated state, is given by:
\begin{align}
P_k^- &= F_k\ P_{k-1}^-F^\top + Q_k\\
\text{dim}(P_k^-) &= [10 \times 10]\cdot [10 \times 10]\cdot [10 \times 10]^\top + [10 \times 10]
\end{align}
The posteriori error covariance matrix, the update, is given by:
\begin{align}
P_k^+ &= (I - K_k\ H_k)P_k^-\\
\text{dim}(P_k^+) &= ([10 \times 10] - [10 \times 7]\cdot [7 \times 10])\cdot [10 \times 10]
\end{align}
which is a measure of the estimated accuracy of the state estimate. Adding a middle calculation as the residual covariance:
\begin{align}
S_k &= H\ P\ H^\top + R\\
\text{dim}(S_k) &= [7 \times 10]\cdot [10x10]\cdot [7 \times 10]^\top + [10 \times 10]
\end{align}
The updated Kalman Gain:
\begin{align}
K_k &= P\ H^\top\ S^{-1}\\
\text{dim}(K_k) &= [10 \times 10]\cdot [7 \times 10]^\top\cdot [7 \times 7]^{-1}
\end{align}
witch is optimal in a \ac{MMSE} sense.



\begin{align}
H_k =
\begin{bmatrix}
1 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 \\
0 & 1 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 \\
0 & 0 & 0 & 0 & 1 & 0 & 0 & 0 & 0 & 0 \\
0 & 0 & 0 & 0 & 0 & 1 & 0 & 0 & 0 & 0 \\
0 & 0 & 0 & 0 & 0 & 0 & 1 & 0 & 0 & 0 \\
0 & 0 & 0 & 0 & 0 & \frac{\delta}{\delta u} & 0 & 0 & 0 & 0 \\
0 & 0 & 0 & 0 & 0 & 0 & \frac{\delta}{\delta v} & 0 & 0 & 0
\end{bmatrix}
\end{align}

