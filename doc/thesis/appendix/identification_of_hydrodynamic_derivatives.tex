\chapter{Identification of hydrodynamic coefficients}
\label{app:damping}

\section{Purpose}
The purpose with this test is to
identify the hydrodynamic coefficients used in the linear model for
AAUSHIP.

\section{Theory} The theory behind this measurement journal is as
described in section \ref{sec:hydrocoeff}, and is expanded in this
journal to explicitly get the coefficients needed. The purpose is to
identify the hydrodynamic damping coefficients for the 5 \ac{DOF} damping
matrix~\vref{eq:damping-matrix}. This is accomplished by
three sea trails; a surge test, a sway test and a yaw
test, together with roll and pitch tests in a small basin.

%but some of these have been estimated by \citep{13gr931} and are used directly from that work.

%\todo{Are we using the values 13gr931 found, else, state which
%	parameters exactly. If then, it might be better to state them as a
%result. Or if not used here at all, then don't mention them.}

%\todo{There is no explicit equations on how to actually
%evaluate/calculate the data}

The surge, sway and yaw tests are performed with theory of one method of testing, and theory of another method is used when determining pitch and roll. The damping in surge, sway and yaw is estimated by fitting data to a first order differential equation where the pitch and roll dampings are determined from fitting onto a second order differential equation. These two ways of determining the damping coefficients will be denoted \textit{method one} for the first order fitting and \textit{method two} for the second order fitting.

\subsection{Method one}
\label{subsec:methodone}
This method is used to fit a first order differential equation to be able to estimate the damping coefficient. This is done by performing a test of the vessel. The vessel is accelerated to a constant velocity from where the input is taken away. This will make a velocity curve as seen on figure \ref{fig:phase3}.
\begin{figure}[htbp]
	\centering
	\includesvg[width=0.5\textwidth]{phase3}
	\caption{Constant velocity followed by zero input.}
	\label{fig:phase3}
\end{figure}
From this it is possible to fit the dynamic model including damping of the vessel such that the damping coefficient can be determined. When looking at the motion in surge, this should be fitted by the following method. The dynamic equation in surge, as a homogeneous equation, is given by:
\begin{align}
m \ddot x + D \dot x &= 0
\label{eq:dynsurgeeq}
\end{align}
A guess to fit such a first order differential equation could be:
\begin{align}
u = k \cdot \euler^{-st}
\end{align}
This is the expression of the surge speed, as seen from figure \ref{fig:phase3}. This is plugged into the dynamic equation to be able to fit the dynamic equation to the differential equation.
\begin{align}
m \dot u + Du &= 0\\
m \cdot (-ks\euler^{-st}) + D \cdot k \cdot \euler^{-st} &= 0\\
-ms+D&=0\\
s&=\frac{D}{m}
\end{align}
This makes the surge velocity to be expressed as:
\begin{align}
u = k \cdot \euler^{-\frac{D}{m}t}
\end{align}
By setting the time to zero gives the initial velocity:
\begin{align}
u_0 = k
\end{align}
After the damping is determined is the input force the only unknown in the dynamic equation \eqref{eq:dynsurgeeq}. The input force, to reach the constant velocity $u_0$, can be determined by the same principle but should be applied to a curve rising from zero velocity to the constant velocity. This would look as seen in figure \ref{fig:phase1}.
\begin{figure}[htbp]
	\centering
	\includesvg[width=0.5\textwidth]{phase1}
	\caption{Zero velocity followed by constant velocity.}
	\label{fig:phase1}
\end{figure}
The differential equation to fit this curve would be given by the inhomogeneous equation:
\begin{align}
u_{\text{inh}} &= u_0 - u_{\text{h}}\\
u &= u_0 - k \cdot \euler^{-st}
\end{align}
where the $s$ still would be given as:
\begin{align}
s = \frac{D}{m}
\end{align}
From this is the input force, to reach $u_0$, given from:
\begin{align}
m \dot u + Du &= \tau
\end{align}

\subsection{Method Two}
\label{subsec:methodtwo}
The second method is used when determining coefficients as pitch and roll, $r$ and $p$. In these tests is the vessel put to a maximum angle in pitch or roll and afterwards released. This will make the vessel converge to steady state, as seen on figure~\vref{fig:harmonic-damping}. This damping must be determined by fitting the damping to a second order differential equation. This can be illustrated by looking at the determination of the damping coefficient $Y_p$.

The damping coefficient $Y_p$ can be found from the dynamic equation of roll by:
\begin{align}
mZ_g\ddot \varphi + Y_p\dot \varphi + G\varphi = 0
\label{eq:solveddyneq}
\end{align}
$\varphi$ is the position of the angle of the vessel. This is the position that needs to follow the damping as seen on figure~\vref{fig:harmonic-damping}. This can be fit to a second order differential equation. The position of the angle can be expressed as:
\begin{align}
\varphi = k\euler^{-st} \cdot \cos(\omega t)
\end{align}
This is an under damped system, which has a standard second order polynomial given by:
\begin{align}
a\ddot y + b\dot y + cy = 0
\end{align}
Which can be normalized with the coefficient of $a$, such that it takes the form:
\begin{align}
\ddot y + \frac{b}{a}\dot y + \frac{c}{a}y = 0
\label{eq:parameterized}
\end{align}
For an under damped system this can be seen as:
\begin{align}
\ddot y + b\dot y + cy = 0\\
\ddot y + 2\zeta \omega_0 \dot y + \omega_0^2 y = 0
\label{eq:normalized}
\end{align}
The solution to this is guessed as:
\begin{align}
y(t) = k\euler^{-st} \cos{\omega_dt}
\label{eq:solutionguess}
\end{align}
Substituting this into \ref{eq:normalized}, and transforming, gives:
\begin{align}
s^2k\euler^{-st} \cos{\omega_dt} + 2\zeta \omega_0sk\euler^{-st} \cos{\omega_dt} + \omega_0^2k\euler^{-st} \cos{\omega_dt} = 0
\end{align}
Which can be divided by $k\euler^{-st} \cos{\omega_dt}$:
\begin{align}
s^2 + 2\zeta \omega_0s + \omega_0^2 = 0
\label{eq:dampeq}
\end{align}
The solution for the second order polynomial in \ref{eq:dampeq} can be expressed as:
\begin{align}
s = \frac{-2\zeta \omega_0 \pm \sqrt{4\zeta^2\omega_0^2-4\omega_0^2}}{2}
\end{align}
where:
\begin{align}
a &= 1\\
b &= 2\zeta \omega_0\\
c &= \omega_0^2
\end{align}
Which for an under damped system can be expressed as:
\begin{align}
s &\stackrel{\zeta < 1}{=} -\zeta\omega_0\pm\omega_0\sqrt{1-\zeta^2}\\
&=-\sigma\pm j\omega_d
\end{align}
Where:
\begin{align}
\zeta\omega_0 &= s\ \text{from equation} \ref{eq:solutionguess}, \text{which is the real part}\\
\omega_0\sqrt{1-\zeta^2} &= \omega_d\ \text{from equation} \ref{eq:solutionguess}, \text{which is the imaginary part}
\end{align}
By comparing \ref{eq:dyneq}, \ref{eq:parameterized} and \ref{eq:dampeq} it can be seen that:
\begin{align}
a &= 1\\
b &= 2\zeta\omega_0 = \frac{Y_p}{m}\\
c &= \omega_0^2 = \frac{G}{m}
\end{align}
From the fitting of data is two variables known:
\begin{align}
s &= \zeta\omega_0\\
\omega_d&=\omega_0\sqrt{1-\zeta^2}
\end{align}
This makes it possible to determine $Y_p$ by:
\begin{align}
b = 2\zeta\omega_0 = 2s = \frac{Y_p}{m}\\
Y_p = 2sm
\end{align}
The coefficient $G$ can be determined by:
\begin{align}
\omega_d = \omega_0\sqrt{1-\zeta^2}\\
\omega_d^2 = \omega_0^2-(\zeta\omega_0)^2 = c - s^2 = \frac{G}{m}-s^2\\
G = \omega_d^2m+s^2m
\end{align}
This makes the dynamic equation with roll as:
\begin{align}
mZ_g\ddot \varphi + Y_p\dot \varphi + G\varphi = 0\\
mZ_g\ddot \varphi + (2sm)\dot \varphi + (\omega_d^2m+s^2m)\varphi = 0
\label{eq:solveddyneq}
\end{align}


%This can be rewritten by the following:
%\begin{align}
%-mZ_g\ddot \varphi + Y_p\dot \varphi - \tau_{hyd,hs} = 0\\
%as^2+bs+c=0
%\end{align}
%This makes, in the standard solution of the second order equation, $a=-mZ_g$, $b=Y_p$ and $c=-\tau_{hyd,hs}$. The standard solution will then become:
%\begin{align}
%s &= \frac{-b\pm\sqrt{b^2-4ac}}{2a}\\
%s &= \frac{-Y_p\pm\sqrt{Y_p^2-4(-mZ_g)\tau_{rest}}}{2(-mZ_g)}
%\end{align}
%This can then be fit to a position given by the previous:
%\begin{align}
%\varphi = k\euler^{\left(\frac{-Y_p\pm\sqrt{Y_p^2-4(-mZ_g)\tau_{rest}}}{2(-mZ_g)}\right)t} \cdot \cos(\omega t)
%\end{align}
%This makes a solution at zero degree, being the horizontal equilibrium, as:
%\begin{align}
%s\big|_{\varphi=0} = \frac{-Y_p}{-2mZ_g}
%\end{align}

\subsection{Which parameters to determine}
The parameters that needs to be determined is the damping coefficients from the damping matrix. The 5 \ac{DOF} damping matrix is given by:
\begin{align}
D = -
\begin{bmatrix}
X_u & 0 & 0 & 0 & 0\\
0 & Y_v & Y_p & 0 & Y_r\\
0 & K_v & K_p & 0 & K_r\\
0 & 0 & 0 & M_q & 0\\
0 & N_v & N_p & 0 & N_r
\end{bmatrix}
\end{align}
The different coefficients can be found by writing the complete dynamic system:
\begin{align}
M_{RB} \dot \nu + D\nu = \tau
\end{align}
where:
\begin{align}
\nu =
\begin{bmatrix}
u & v & p & q & r
\end{bmatrix}^T
\end{align}
and
\begin{align}
M_{RB} =
\begin{bmatrix}
m & 0 & 0 & mz_g & -my_g\\
0 & m & -mz_g & 0 & mx_g\\
0 & -mz_g & I_x & -I_{xy} & -I_{xz}\\
mz_g & 0 & -I_{yx} & I_y & -I_{yz}\\
-my_g & mx_g & -I_{zx} & -I_{zy} & I_z
\end{bmatrix}
\end{align}
The full dynamic system equations can then be written as:
\begin{align}
M_{RB1}\dot \nu + D_{1} \nu &= \tau\\
M_{RB2}\dot \nu + D_{2} \nu &= \tau\\
M_{RB3}\dot \nu + D_{3} \nu &= \tau\\
M_{RB4}\dot \nu + D_{4} \nu &= \tau\\
M_{RB5}\dot \nu + D_{5} \nu &= \tau
\end{align}
Which can be outlined as:
\begin{align}
\begin{bmatrix}
m & 0 & 0 & mz_g & -my_g
\end{bmatrix}
\dot \nu &+
\begin{bmatrix}
X_u & 0 & 0 & 0 & 0
\end{bmatrix}
\nu = \tau\\
\begin{bmatrix}
0 & m & -mz_g & 0 & mx_g
\end{bmatrix}
\dot \nu &+
\begin{bmatrix}
0 & Y_v & Y_p & 0 & Y_r
\end{bmatrix}
\nu = \tau\\
\begin{bmatrix}
0 & -mz_g & I_x & -I_{xy} & -I_{xz}
\end{bmatrix}
\dot \nu &+
\begin{bmatrix}
0 & K_v & K_p & 0 & K_r
\end{bmatrix}
\nu = \tau\\
\begin{bmatrix}
mz_g & 0 & -I_{yx} & I_y & -I_{yz}
\end{bmatrix}
\dot \nu &+
\begin{bmatrix}
0 & 0 & 0 & M_q & 0
\end{bmatrix}
\nu = \tau\\
\begin{bmatrix}
-my_g & mx_g & -I_{zx} & -I_{zy} & I_z
\end{bmatrix}
\dot \nu &+
\begin{bmatrix}
0 & N_v & N_p & 0 & N_r
\end{bmatrix}
\nu = \tau
\end{align}
The equations equal $\tau$, being the input to the vessel. Some of the contributions cannot have an input, since actuators for controlling pitch and roll is not implemented.

From the first row can the following be outlined:
\begin{align}
m\dot u + X_uu = \tau_{u}
\end{align}
From the second row can the following be outlined:
\begin{align}
m\dot v + Y_vv &= \tau_{v}\\
-mz_g\dot p + Y_pp &= 0\\
mx_g\dot r + Y_rr &= \tau_{r}
\end{align}
From the third row can the following be outlined:
\begin{align}
-mz_g\dot v + K_vv &= \tau_{v}\\
I_x\dot p + K_pp &= 0\\
-I_{xy}\dot q &= 0\\
-I_{xz}\dot r + K_rr &= \tau_{r}\\
\end{align}
From the forth row can the following be outlined:
\begin{align}
mz_g\dot u &= \tau_{u}\\
-I_{yx}\dot p &= 0\\
I_y\dot q + M_qq &= 0\\
-I_{yz}\dot r &= \tau_{r}\\
\end{align}
From the fifth row can the following be outlined:
\begin{align}
-my_g\dot u &= \tau_{u}\\
mx_g\dot v + N_vv &= \tau_{v}\\
-I_{zx}\dot p + N_pp &= 0\\
-I_{zy}\dot q &= 0\\
I_z\dot r + N_rr &= \tau_{r}
\end{align}
These equations can be utilized to calculate the coefficients from the damping matrix $D$. The coefficients regarding surge, sway and yaw, $u$, $v$ and $r$, will be determined by \textit{method one} and coefficients regarding pitch and roll, $q$ and $p$, will be determined by \textit{method two}.

\subsubsection{Surge test}
\begin{align}
m\dot u + X_uu = \tau_{u}
\end{align}
where only \textit{method one} is used.

\subsubsection{Sway test}
\begin{align}
m\dot v + Y_vv &= \tau_{v}\\
-mz_g\dot v + K_vv &= \tau_{v}\\
mx_g\dot v + N_vv &= \tau_{v}
\end{align}
where only \textit{method one} is used.

\subsubsection{Yaw test}
\begin{align}
mx_g\dot r + Y_rr &= \tau_{r}\\
-I_{xz}\dot r + K_rr &= \tau_{r}\\
I_z\dot r + N_rr &= \tau_{r}
\end{align}
where only \textit{method one} is used.

\subsubsection{Pitch test}
\begin{align}
I_y\dot q + M_qq = 0\\
\end{align}
where only \textit{method two} is used.

\subsubsection{Roll test}
\begin{align}
-mz_g\dot p + Y_pp &= 0\\
I_x\dot p + K_pp &= 0\\
-I_{zx}\dot p + N_pp &= 0
\end{align}
where only \textit{method two} is used.

\section{Tools}
Tools needed are:
\begin{itemize}
	\item AAUSHIP equipped with:
		\begin{enumerate}
			\item Controller for surge only
			\item Controller for sway only
			\item Controller for yawing only
			\item Logging capability for \ac{IMU}, GPS1, GPS2 with UBX data
				and control inputs.
		\end{enumerate}
	\item Computer to set remote parameters and tele operation
	\item RTK base station logging UBX data.
\end{itemize}
To be able to make the tests the AAUSHIP needs to have both forward thrusters and sideways thrusters. These are implemented and can be controlled from a computer.

\section{Method}
The tests performed are as follows:
\begin{enumerate}
	\item The first test is a \textit{surge} test. This test is done to test the forward damping coefficient being $X_u$ from the damping matrix $D$. The vessel will accelerate to a certain velocity and keep this. Then all input is put to zero and the vessel will decelerate. This will, as described in section \ref{sec:hydrocoeff}, give a damping coefficient in the forward motion. This is expressed as $m \ddot x - X_u \dot x = 0$ and $X_u$ can be estimated. A step input is now set on the vessel to see the acceleration from zero velocity to the same constant velocity as before. This now gives the input force at the vessel, which is the last unknown in $m \ddot x - X_u \dot x = \tau$. Both $X_u$ and $\tau$ is estimated by fitting to a first order differential curve, as described in \ref{subsec:methodone}. To make this test and data fitting is only position data in the forward motion from the \ac{GPS} of importance. The position can be differentiated twice, to give both velocity and acceleration of the vessel and cab be used to fit the acceleration and deceleration of the vessel.
	\item The second test is a purely \textit{sway} test. The vessel will make use of the sideways thrusters to move strictly sideways. This implies that there is no rotation or movement in $\psi$ and $x$. Thus makes the moving equation as $m \ddot y - Y_v \dot y = 0$. Here is the vessel again accelerated to a constant velocity and the input is then set to zero, and $Y_v$ can be determined. After this the sideways thrusters can be used to accelerate the vessel to the same constant velocity and the input can be estimated by $m \ddot y - Y_v \dot y = \tau$ where $\tau$ is the only unknown. $K_v$ and $N_v$ can be determined from the same test, though the fitting needs to be changed due to the new parameter from $M_{RB}$. The fitting should be done to the same type, namely like procedure \textit{method one} in \ref{subsec:methodone}. To make this test and data fitting is only position data in sideways motion from the \ac{GPS} of importance. This can be differentiated twice to give both velocity and acceleration in the sideways direction. This can be fitted to a acceleration and deceleration of the vessel when only moving in the sideways direction.
	\item The last test to perform is the \textit{yaw} test. In this test it is of importance to control the sideways thrusters such that the vessel will keep the position at both $x$ and $y$, such that only rotation is used to move the surrounding water. The vessel is accelerated to a constant angular velocity and the input is then set to zero. The damping of this will determine $N_r$ from $I_z\ddot \psi - N_r \dot \psi = 0$. Now the vessel needs to reach the constant angular velocity again from zero, and the input can now be estimated from $I_z\ddot \psi - N_r \dot \psi = \tau$. $Y_r$ and and $K_r$ can be determined from the same test, but the fitting is a little different due to the new parameter from $M_{RB}$. These fittings should be done as procedure \textit{method one} in \ref{subsec:methodone}. To make these should the position from the \ac{GPS} be measured to ensure that the vessel does not move of greater importance in forward and sideways directions. Measurements from the magnetometer and accelerometer is used to determine the heading and thereby the change on heading and the acceleration. The accelerometer is used to compensate the pitch and roll in the magnetometer measurements.
\end{enumerate}
The parameters in pitch and roll is determined by fitting data to \textit{method two} as described in \ref{subsec:methodtwo}. Previous work done by \citep{13gr931} has provided the data to be fitted. These data can be found on the cd, \todo{ref til cd}. The data is dependent of the position on the angle of the vessel and the equations is therefore formulated to fit these measurements. The fitting of the data is done as procedure \textit{method two} and no further tests needs to be performed. The tests shows pitch and roll, measured in a vicon motion tracking lab. The vessel is put to a maximum angle without level it into the water. Afterwards it is released and the vessel will damp to zero angle, being horizontal in steady water. To verify the data from \citep{13gr931} accelerometer will be collected both in pitch and roll from two simpler tests without the vicon motion tracking lab.

\section{Results}
\subsubsection{Surge test}
\missingfigure{Maalinger af acceleration fra 0 til konstant hastighed
+ Maaling af deceleration med 0 input fra konstant hastighed +
regræssionskurve af disse}
\subsubsection{Sway test}
\missingfigure{Maalinger af acceleration fra 0 til konstant hastighed
+ Maaling af deceleration med 0 input fra konstant hastighed +
regræssionskurve af disse}
\subsubsection{Yaw test}
\missingfigure{Maalinger af acceleration fra 0 til konstant vinkel
hastighed + Maaling af deceleration med 0 input fra konstant vinkel
hastighed + regræssionskurve af disse}
\subsubsection{Pitch test}
\missingfigure{Maalinger af deceleration fra max vinkel til steady state + regræssionskurve af disse + sammenligning med lunde og brian}
\subsubsection{Roll test}
\missingfigure{Maalinger af deceleration fra max vinkel til steady state + regræssionskurve af disse + sammenligning med lunde og brian}

The rigid body constants for the vessel can be found in table \ref{tab:constants} and the results from measurements and estimation can be found in table \ref{tab:dmatrix}.
\todo{Disse skal måles op og sættes ind}
\begin{table}[htbp]
\centering
\begin{tabular}{ccc}
	\toprule
  Coefficient & Value \\
  \midrule
  $m$ & 2 \\
  $x_g$ & 2 \\
  $z_g$ & 2\\
  $I_{xz}$ & 2 \\
  $I_z$ & 2 \\
  $I_y$ & 2 \\
  $I_x$ & 2 \\
  $I_{zx}$ & 2 \\
  \bottomrule
\end{tabular}
\caption{Rigid body mass matrix constants for $M_{RB}$}
\label{tab:constants}
\end{table}

\begin{table}[htbp]
\centering
\begin{tabular}{ccc}
	\toprule
  Hydrodynamic\\Coefficient & Value \\
  \midrule
  $X_u$ & 2 \\
  $Y_v$ & 2 \\
  $K_v$ & 2 \\
  $N_v$ & 2 \\
  $N_r$ & 2 \\
  $Y_r$ & 2 \\
  $K_r$ & 2 \\
  $Y_p$ & 2 \\
  $K_p$ & 2 \\
  $N_p$ & 2 \\
  $M_q$ & 2 \\
	\bottomrule
\end{tabular}
\caption{Results of fitted values and the calculated coefficients.}
\label{tab:dmatrix}
\end{table}
This makes the linear damping matrix as:
\begin{align}
D = -
\begin{bmatrix}
X_u & 0 & 0 & 0 & 0\\
0 & Y_v & Y_p & 0 & Y_r\\
0 & K_v & K_p & 0 & K_r\\
0 & 0 & 0 & M_q & 0\\
0 & N_v & N_p & 0 & N_r
\end{bmatrix}
\end{align}

\section{Discussion}


\section{Conclusion}

